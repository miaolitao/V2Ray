name: æ›´æ–°èŠ‚ç‚¹

on:
  # å®šæ—¶è§¦å‘ï¼ˆæ¯ 6 å°æ—¶ï¼‰
  schedule:
    - cron: '0 */6 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      skip_test:
        description: 'è·³è¿‡æµ‹é€Ÿ'
        required: false
        type: boolean
        default: false
      format:
        description: 'è¾“å‡ºæ ¼å¼'
        required: false
        type: choice
        options:
          - all
          - base64
          - clash
          - v2ray
          - surge
          - quantumult
        default: all

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: å®‰è£… uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: å®‰è£…ä¾èµ–
        run: |
          uv pip install --system -e .
      
      - name: è¿è¡ŒèŠ‚ç‚¹æ›´æ–°
        run: |
          if [ "${{ github.event.inputs.skip_test }}" = "true" ]; then
            python main.py --skip-test --format ${{ github.event.inputs.format || 'all' }}
          else
            python main.py --format ${{ github.event.inputs.format || 'all' }}
          fi
      
      - name: è¯»å–ç»Ÿè®¡ä¿¡æ¯
        id: stats
        run: |
          if [ -f output/latest/stats.json ]; then
            TOTAL=$(jq -r '.total_nodes' output/latest/stats.json)
            echo "total_nodes=$TOTAL" >> $GITHUB_OUTPUT
          else
            echo "total_nodes=0" >> $GITHUB_OUTPUT
          fi
      
      - name: æäº¤æ›´æ–°
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # å¼ºåˆ¶æ·»åŠ è¾“å‡ºç›®å½•ï¼ˆç»•è¿‡ .gitignoreï¼‰
          git add -f output/latest
          git add -f output/[0-9]*
          
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "ğŸ”„ æ›´æ–°èŠ‚ç‚¹ - $(date '+%Y-%m-%d %H:%M:%S') - èŠ‚ç‚¹æ•°: ${{ steps.stats.outputs.total_nodes }}"
            git push
          else
            echo "æ²¡æœ‰æ›´æ–°"
          fi
      
      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: v2ray-nodes-${{ github.run_number }}
          path: |
            output/
            logs/
          retention-days: 7

